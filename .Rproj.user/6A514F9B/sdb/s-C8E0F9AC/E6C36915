{
    "contents" : "---\ntitle: \"analysis for transitions paper3\"\nauthor: \"Nishant Sahni\"\ndate: \"May 24, 2015\"\noutput: html_document\n---\n\n\n\nset up the wd\n```{r set wd}\nsetwd(\"~/Desktop/Sepsis QI Project 2015 June\")\nlibrary(dplyr)\nlibrary(lubridate)\nlibrary(broom)\n```\n\n\n```{r read analysis file}\ntransition_p <- read.csv(\"~/Desktop/Sepsis QI Project 2015 June/transition_p\")\nView(transition_p)\ntemp <- transition_p\n```\n\n\n\nHere is the model that would be the one for the whole dataset. \n```{r}\ntemp$in_er.x <- as.factor(temp$in_er.x)\ntemp$in_er.y <- as.factor(temp$in_er.y)\ntemp$in_er.x <- relevel(temp$in_er.x,ref=TRUE)\ntemp$in_er.y <- relevel(temp$in_er.y,ref=TRUE)\n\nmodel <- glm(data=temp, inhospital_death.x~in_er.x+in_er.y+age.x+Charlson,family=binomial)\nsummary(model)\n\n```\n\n```{r,eval=FALSE}\nless <- filter(temp,time_to_abx>24 )\ncool <- data %>% inner_join(less,by=\"PAT_ENC_CSN_ID\") %>% select(MRN,ADM_DATE_TIME)\n```\n\n\n\n\nFilter the model\n```{r}\ntemp <- mutate(temp,time_to_abx=ifelse(time_to_abx<0,1,time_to_abx)) ## reviewed the negative times (they were transfers from riverside)\ntemp <- mutate(temp,time_to_bolus=ifelse(time_to_abx<0,1,time_to_bolus))\ntemp <- filter(temp, time_to_abx<=48 & time_to_abx>0)\ntemp$in_er.x <- relevel(temp$in_er.x,\"TRUE\")\ntemp$in_er.y <- relevel(temp$in_er.y,\"TRUE\")\n##ed_lact_df <- select(transition_p2,PAT_ENC_CSN_ID,ed_bc_ordered,ed_lact_ordered)\n\n\nmodel <- glm(data=temp, inhospital_death.x~in_er.x+in_er.y+age.x,family=binomial)\nsummary(model)\n\ntable <- tbl_df(tidy(model))\ntable2 <- table %>% mutate(Odds=round(exp(estimate),2)) %>% mutate(Lower_bounds=round(exp(estimate-std.error),2),.) %>% mutate(Upper_bounds=round(exp(estimate+std.error),2),.) \n\ntable2$term[[2]] <- c(\"Antibiotics not administered in the ER\")\ntable2$term[[3]] <- c(\"IV fluids not administered in the ER\")\ntable2$term[[4]] <- c(\"Age\")\n\n\n```\n\n\nGet the values of the median time to abx etc\n```{r}\n\n## global median and range\nmedian(as.numeric(temp$time_to_abx))\nmedian(as.numeric(temp$time_to_bolus))\nrange(as.numeric(temp$time_to_bolus))\nrange(as.numeric(temp$time_to_abx))\nwith(temp,table(in_er.x)) ## proportion of patients got abx in er or not\nwith(temp,table(in_er.y))## proportions of  patients got ivf in er or not\n\n```\n\n```{r abx stats}\n\n## median broken down by wether in er or not\nabx_er <- temp %>% filter(in_er.x==TRUE) ## create small dataset for pts who got abx in er\nno_abx_er <- temp %>% filter(in_er.x==FALSE) ## create small dataset for pts who didnt get abx in er\nmedian(as.numeric(abx_er$time_to_abx)) ## find median time to abx within that group\nIQR(as.numeric(abx_er$time_to_abx))\nmedian(as.numeric(no_abx_er$time_to_abx)) ## find median time to abx within that group\nIQR(as.numeric(no_abx_er$time_to_abx))\n            \n\n```\n\n```{r}\nadmin_dept <- read.csv(\"~/Desktop/Sepsis QI Project 2015 June/admin_dept\")\nadmin_dept_4a <- admin_dept %>% filter(ADMIN_DEPT_NAME==\"UU U4A|UU U4B\") \nmedian(admin_dept_4a$time_to_abx)\nadmin_dept_6b <- admin_dept %>% filter(ADMIN_DEPT_NAME==\"UU U6B\") \nmedian(admin_dept_6b$time_to_abx)\n```\n\n\n```{r bolus stats}\n## median broken down by wether in er or not\nbolus_er <- temp %>% filter(in_er.y==TRUE) ## create small dataset for pts who got bolus in er\n\nlength(unique(bolus_er$PAT_ENC_CSN_ID)) ## number of patients who got a bolus in er\n\nno_bolus_er <- temp %>% filter(in_er.y==FALSE) ## create small dataset for pts who didnt get bolus in er\n\nlength(unique(no_bolus_er$PAT_ENC_CSN_ID)) ## \nmedian(as.numeric(bolus_er$time_to_bolus)) ## find median time to bolus within that group\nIQR(as.numeric(bolus_er$time_to_bolus)) ## IQR\nmedian(as.numeric(no_bolus_er$time_to_bolus)) ## find median time to bolus within that group\n   IQR(as.numeric(no_bolus_er$time_to_bolus))         \n\n```\n\nRates of in hospital death.\n\n```{r in_hospital death}\nwith(temp,table(inhospital_death.x))\n\nchisq.test(with(temp,table(inhospital_death.x,in_er.x)))\n\n```\n  Pearson's Chi-squared test with Yates' continuity correction\n\ndata:  with(temp, table(inhospital_death.x, in_er.x))\nX-squared = 5.2426, df = 1, p-value = 0.02204\n\n```\n\nAdd in elements from bundle_data to the current dastaframe\n```{r}\nbundle_data <- read.csv(\"~/Desktop/Sepsis QI Project 2015 June/bundle_data3\")\n\nbundle_data= mutate(bundle_data,ed_arrival_lact=difftime(ymd_hms(LACTIC_RESULT_TIME),ymd_hms(ED_ARRIVAL),units=\"hours\"))\nbundle_data= mutate(bundle_data,ed_arrival_lact=difftime(ymd_hms(LACTIC_RESULT_TIME),ymd_hms(ED_ARRIVAL),units=\"hours\"))\n\nbundle_data2 <- select(bundle_data,c(34:43,3,4,24,12,6,25,26,44)) \ntemp2 <- temp %>% left_join(bundle_data2,by=\"PAT_ENC_CSN_ID\")\n # temp3 <- temp %>% (bundle_data2,by=\"PAT_ENC_CSN_ID\")\n```\n\n```{r}\nlact_er <- bundle_data %>% select(ed_arrival_lact,ed_lact_ordered) %>%\n  filter(ed_arrival_lact <48 & ed_arrival_lact >0.3) %>% group_by(ed_lact_ordered) %>% summarise(median_lact=median(ed_arrival_lact),iqr=IQR(ed_arrival_lact))\n\n```\n\n model <- glm(data=bundle_data,inhospital_death~ed_lact_ordered+age)\n> summary(model)\n\n\nlets add in the lactate data to transitions_p\n```{r}\nbundle_data <- mutate(bundle_data,inhospital_death=grepl(\"Expired\",DISCH_DISP))\nmodule <- bundle_data %>% select(PAT_ENC_CSN_ID,ed_lact_ordered,ed_bc_ordered,ed_bc_taken,ed_lact_result,ORDER_SET_NAME,LACTATE_VALUE,ed_arrival_lact,age,inhospital_death)\nmodule2 <- mutate(module,order_set=(grepl(x=ORDER_SET_NAME,\"ED\")))\ntransition_p2<- left_join(transition_p,module2,by=\"PAT_ENC_CSN_ID\")\ntransition_p2 <- mutate(module,order_set=(grepl(x=ORDER_SET_NAME,\"ED\")))\ntransition_p2 <- mutate(transition_p2,no_lact=is.na(LACTATE_VALUE))\n\n```\n\n```{r how many patients had a lactate}\ntable(transition_p2$no_lact)\n139/(453+139)\n```\nlate discovery of an elevated lactate\n\n```{r lactate}\nhilac <- subset(temp2,LACTATE_VALUE>=3)\nmodel <- glm(data=hilac,inhospital_death.x~(ed_arrival_lact>3)+age.x)\nsummary(model)\nexp(0.22)\nexp(0.22-0.10)\nexp(0.22+0.10)\n```\n\nmodel <- glm(inhospital_death~order_set,data=transition_p2,family=\"binomial\")\nsummary(model)\n\n```\n```{r}\ntransition_p2$no_lact <- relevel(as.factor(transition_p2$no_lact),\"TRUE\")\nlact_order <- glm(inhospital_death~no_lact,family=\"binomial\",data=transition_p2)\nexp(3.4+1.0)\nexp(3.4-1.0)\nexp(3.403)\n\n```\n\n```{r}\n\ntransition_p3 <- mutate(transition_p2,er_lact_check=(ed_lact_ordered==TRUE))\n\n```\n\n\n```{r assess impact of qiscore1 with lac}\nlibrary(rms)\norderdb <- left_join(transition_p,transition_p3,by=\"PAT_ENC_CSN_ID\")\n\norder_db2 <- orderdb %>% mutate(er_bc_check=(ed_bc_ordered==TRUE),.) \n  \norder_db3 <- mutate(order_db2,qi_score_lac=in_er.x+in_er.y+er_bc_check+er_lact_check) \n\norder_db2 <- mutate(order_db3,qi_score2=in_er.x+in_er.y+er_bc_check)\n\n```\n\n```{r}\n##order_db2$qi_score <- relevel(as.factor(order_db2$qi_score_lac),ref=0)\nqi_model <- glm(inhospital_death.x~qi_score_lac+age.x,data=order_db2,family=\"binomial\")\nsummary(qi_model)\nlibrary(rms)\n\nqi_model2 <- lrm(inhospital_death.x~qi_score_lac,data=order_db2)\nprediction <- Predict(qi_model2,qi_score_lac=seq(0,4,by=1))\nprediction <- tbl_df(prediction) \n\nqi_model2 <- lrm(inhospital_death.x~qi_score_lac,data=order_db2)\nprediction <- Predict(qi_model2,qi_score=seq(0,4,by=1))\nplot1 <- ggplot(data=prediction,aes(x=qi_score_lac,y=exp(yhat))) + geom_bar(stat=\"identity\",alpha=0.7) + geom_errorbar(aes(ymin=exp(lower),ymax=exp(upper)),width=0.2) +xlab(c(\"SERQ2\"))+ylab(c(\"Odds of In-Hospital Death\"))\n\n\n```\n\n\n```{r}\n##order_db2$qi_score <- relevel(as.factor(order_db2$qi_score2),ref=0)\nqi_model <- glm(inhospital_death.x~qi_score2+age.x,data=order_db2,family=\"binomial\")\nsummary(qi_model)\n\nqi_model2 <- lrm(inhospital_death.x~qi_score2,data=order_db2)\nprediction <- Predict(qi_model2,qi_score2=seq(0,3,by=1))\nprediction <- tbl_df(prediction) ## %>% (qi_score2)\n\n\nqi_model2 <- lrm(inhospital_death.x~qi_score2,data=order_db2)\nprediction <- Predict(qi_model2,qi_score=seq(0,3,by=1))\nplot2 <- ggplot(data=prediction,aes(x=qi_score2,y=exp(yhat))) + geom_bar(stat=\"identity\",alpha=0.7) + geom_errorbar(aes(ymin=exp(lower),ymax=exp(upper)),width=0.2) +xlab(c(\"SERQ1\"))+ylab(c(\"Odds of In-Hospital Death\"))\nmedian(order_db2$qi_score2,na.rm=TRUE)\n```\n\n\n```{r orderset qi score}\n\n## was the quality score associated with order_set use\n\norderset <- glm(qi_score2>=2~order_set, family=\"binomial\",data=order_db2)\nsummary(orderset)\n\n##orderset <- glm(inhospital_death.x~order_set+age.x, family=\"binomial\",data=order_db2)\nsummary(orderset)\n\n```\n\n```{r}\nqplot(data=order_db2,qi_score2,type=\"density\",fill=order_set)\nmedian()\n```\n\n```{r}\nabx_det <- unified_abx %>% select(dept_abx_given=ADMIN_DEPT_NAME)\ntransition_p2 <- left_join(transition_p,vessel,by=\"PAT_ENC_CSN_ID\")\n##transition_p2 <- transition_p2 %>% mutate(med_floor=grepl(ADMIN_DEPT_NAME,\"U6B|U5A|U5B\"))\n\n```\n\n```{r}\nlibrary(gridExtra)\ndoldrum_abx <- ggplot(data=transition_p,aes(x=as.numeric(time_to_abx),fill=in_er.x))+geom_density(alpha=0.3,colour=grey)+xlim(-2,20)+xlab(\"Hours to first dose of antibiotics\")+ scale_fill_manual(values=c(\"#f0f0f0\",\"#636363\"),labels=c(\"Given in the  ER\",\"Not given in the ER\"),name=\"\")+ggtitle(label = \"Distribution of time to antibiotics\")\n\ndoldrum_ivf <- ggplot(data=transition_p,aes(x=as.numeric(time_to_bolus),fill=in_er.y))+geom_density(alpha=0.3,colour=grey)+xlim(-2,20)+xlab(\"Hours to first dose of IVF bolus\")+ scale_fill_manual(values=c(\"#f0f0f0\",\"#636363\"),labels=c(\"Given in the  ER\",\"Not given in the ER\"),name=\"\")+ggtitle(label = \"Distribution of time to IVF bolus\")\nlact_plot <-ggplot(data=bundle_data,aes(x=as.numeric(ed_arrival_lact),fill=ed_lact_ordered)) + geom_density(alpha=0.3)+xlim(0,20)+ theme(axis.title.x=element_blank()) +ggtitle(\"Distribution of time to Lactate\") +scale_fill_manual(values=c(\"#f0f0f0\",\"#636363\"),labels=c(\"Drawn in ER\",\"Not drawn in ER\"),name=\"\")+xlab(\"Hours to first lactate draw\")\n\n\ngrid.arrange(doldrum_abx,doldrum_ivf,lact_plot)\n\n```\n\nlets arrange try to generate comorbidity scores\n\n```{r}\nlibrary(icd9)\nlibrary(tidyr)\nlibrary(stringr)\n# breakdown the ICD column into seperate parts using splitstackshape\nlibrary(splitstackshape)\nlibrary(icd9)\ndb <- cSplit(indt = transition_p,splitCols = c(\"icd\"),sep = \",\",direction = \"wide\")\n\ndb2 <- gather(db,icd_num,icd_code,icd_01:icd_10) %>% arrange(by=PAT_ENC_CSN_ID)\n\n#db3 <- mutate(db2,icd_code=icd9DecimalToShort(icd_code))\n\nnames(db2)[3]<-c(\"visitId\")\nnames(db2)[14]<- c(\"icd9\")\n\n## generate dataframe with charlson comorbidity scores, append to transitions_p\ncomorb_db <- select(db2,visitId,icd9) \nmat <- icd9Charlson(comorb_db,return.df=TRUE,isShort=TRUE)\nmat <- setnames(mat,\"visitId\",\"PAT_ENC_CSC_ID\")\ntp_ver2 <- left_join(transition_p,mat,by=\"PAT_ENC_CSC_ID\") %>% select(.,-PAT_ENC_CSC_ID) ## save tp_ver2 as transitions_p\n\n```\n",
    "created" : 1436040247810.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "331879549",
    "id" : "E6C36915",
    "lastKnownWriteTime" : 1436201443,
    "path" : "~/Dropbox/Sepsis QI project 2015 June/transition paper analysis3.Rmd",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "type" : "r_markdown"
}